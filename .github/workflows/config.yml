name: Build

on: [push, workflow_dispatch]

jobs:
  build-on-linux:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]

    steps:
      - uses: actions/checkout@v4

      - name: "Configure and build"
        run: |
          cmake . -B build -DFMU4CPP_BUILD_TESTS=ON -DFMU4CPP_BUILD_EXAMPLES=ON
          cmake --build build

      - name: "Read model paths"
        run: |
          MODEL_PATHS=""
          while IFS= read -r line || [ -n "$line" ]; do
            line=$(echo "$line" | tr -d '\r' | xargs)
            if [ -z "$line" ]; then
              continue
            fi
            if [ -z "$MODEL_PATHS" ]; then
              MODEL_PATHS="$line"
            else
              MODEL_PATHS="$MODEL_PATHS;$line"
            fi
          done < build/models.txt
          printf 'MODEL_PATHS=%s\n' "$MODEL_PATHS" >> $GITHUB_ENV
          

      - name: "Download fmusim"
        run: |
          version=0.0.39
          zip=Reference-FMUs-$version.zip
          url="https://github.com/modelica/Reference-FMUs/releases/download/v$version/$zip"
          
          wget -q "$url" -O "$zip"
          mkdir -p "Reference-FMUs"
          unzip -q "$zip" -d "Reference-FMUs"

      - name: "Run fmusim"
        working-directory: "Reference-FMUs/fmusim-x86_64-linux"
        run: |
          IFS=';' read -r -a paths <<< "${{ env.MODEL_PATHS }}"
          for mp in "${paths[@]}"; do
            if [ -z "$mp" ]; then
              continue
            fi
            mb=$(basename "$mp")
          
            echo "Checking model: $mp ($mb)"
            ./fmusim --logging-on "${{ github.workspace }}/build/$mp/$mb.fmu"
          done

      - name: "Test"
        run: |
          ctest --no-tests=error --test-dir build/export/tests --output-on-failure


  build-on-windows:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: "Configure and build"
        run: |
          cmake . -B build -DFMU4CPP_BUILD_TESTS=ON -DFMU4CPP_BUILD_EXAMPLES=ON -A x64 
          cmake --build build --config Release

      - name: "Read model paths"
        shell: pwsh
        run: |
          $paths = Get-Content -Path build/models.txt | ForEach-Object { $_.Trim() } | Where-Object { $_ -ne '' }
          $joined = $paths -join ';'
          "MODEL_PATHS=$joined" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding UTF8

      - name: "Download fmusim"
        shell: pwsh
        run: |
          $version = "0.0.39"
          $zip = "Reference-FMUs-$version.zip"
          $url = "https://github.com/modelica/Reference-FMUs/releases/download/v$version/$zip"
          
          Invoke-WebRequest -Uri $url -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath Reference-FMUs -Force

      - name: "Run fmusim"
        shell: pwsh
        working-directory: "Reference-FMUs/fmusim-x86_64-windows"
        run: |
          $paths = $env:MODEL_PATHS -split ';'
          foreach ($mp in $paths) {
            if ([string]::IsNullOrWhiteSpace($mp)) { continue }
            $mb = Split-Path $mp -Leaf
            Write-Host "Checking model: $mp ($mb)"
            & ./fmusim.exe "$env:GITHUB_WORKSPACE\build\$mp\$mb.fmu"
            if ($LASTEXITCODE -ne 0) {
              Write-Error "FMUChecker failed for $mp with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
          }

      - name: "Test"
        run: |
          ctest -C Release --no-tests=error --test-dir build/export/tests --output-on-failure
